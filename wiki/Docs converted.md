<h1 id="Docsconverted-PageApprovalforConfluenceCloud">Page Approval for Confluence Cloud</h1><p>The quickest, easiest way to simplify the collaborative review and approval of Confluence documents from start to finish</p><h1 id="Docsconverted-Overview">Overview</h1><p>This <code>README.md</code> documents how to setup, deploy this project, and install it on a Confluence Cloud instance site.</p><h1 id="Docsconverted-Structure">Structure</h1><p>This project consists of the following subdirectories, each of them is a Node.js project / npm package:</p><ul><li><p><code>backend/</code>: Confluence Connect app based on Serverless.</p></li><li><p><code>cypress/</code>: Testing platform for the frontend.</p></li><li><p><code>frontend/</code>: JavaScript for browsers to display html.</p></li></ul><h1 id="Docsconverted-ThingstoLearn:Context+FoundationsforPageApprovalCloud">Things to Learn: Context + Foundations for Page Approval Cloud</h1><p>These links should act as a starting point.</p><ul><li><p><a class="external-link" href="https://developer.atlassian.com/cloud/confluence/getting-started-with-connect/" rel="nofollow">Atlassian Connect Express</a></p></li><li><p><a class="external-link" href="https://serverless.com/framework/docs/providers/aws/guide/intro" rel="nofollow">Serverless</a></p></li><li><p><a class="external-link" href="https://serverless.com/aws-lambda/" rel="nofollow">AWS Lambda</a></p></li><li><p><a class="external-link" href="https://support.atlassian.com/confluence-cloud/docs/functional-differences-in-confluence-cloud-vs-server/" rel="nofollow">Confluence Server vs Confluence Cloud</a></p></li><li><p><a class="external-link" href="https://docs.servicerocket.com/pafcc/page-approval-for-confluence-cloud-226166186.html" rel="nofollow">Page Approval for Confluence Cloud</a></p></li></ul><h1 id="Docsconverted-DeployWorkflow">Deploy Workflow</h1><p>To deploy to production, code is passed into and verified through multiple stages/environments. The order is:</p><p>Local -&gt; <a class="external-link" href="https://servicerocket-sydney.atlassian.net/wiki/home" rel="nofollow">Staging</a> -&gt; <a class="external-link" href="https://syd-reporting.atlassian.net/wiki/home" rel="nofollow">Production</a></p><p>The local instance is where you initially implement and test your code for a new feature or ticket. This instance is ran through  <br/>your own execution, thus no reviewing or limitations are enforced to have your code running at this stage.</p><p>The <a class="external-link" href="https://servicerocket-sydney.atlassian.net/wiki/home" rel="nofollow">staging instance</a> is a development 'playground' which is an environment  <br/>which resembles a production environment more accurately. Staging often acts as a final verification stage before deploying to  <br/>production. Getting code to this stage requires a pull request from their branch to develop approved by at least one other individual. There  <br/>can be multiple pull requests from various branches to develop within a singular sprint.</p><p>The <a class="external-link" href="https://syd-reporting.atlassian.net/wiki/home" rel="nofollow">production instance</a> is an instance of the app which is presented to users. App  <br/>must be working in this instance. Getting code to this stage requires a pull request from develop -&gt; master approved by at least  <br/>two other individuals. There can be multiple develop -&gt; master pull requests within a singular sprint.</p><h1 id="Docsconverted-GettingStarted">Getting Started</h1><ol start="1"><li><p>Create an Oracle account and install the relevant <a class="external-link" href="https://www.oracle.com/java/technologies/downloads/#jre8" rel="nofollow">Java SE Runtime Environment (x64)</a> depending on your OS:</p><ul><li><p>DMG installer for macOS</p></li><li><p>EXE installer for Windows</p></li><li><p>RPM-based Linux Distributions (Red Hat, Fedora, CentOS, openSUSE, etc)</p><ul><li><p>First uninstall any earlier installations: <code>rpm -e package-name</code></p></li><li><p>Install the package: <code>rpm -ivh jre-8u*version*-linux-x64.rpm</code></p></li><li><p>To upgrade a package: <code>rpm -Uvh jre-8u*version*-linux-x64.rpm</code></p></li></ul></li><li><p>For all other Linux Distributions:</p><ul><li><p>Download the tarball (.tar.gz)</p></li><li><p>Create an install directory: <code>sudo mkdir /usr/local/java</code></p></li><li><p>Move the tarball into the above directory: <code>sudo mv jre-8u*version*-linux-x64.tar.gz /usr/local/java</code></p></li><li><p>Enter the directory: <code>cd /usr/local/java</code></p></li><li><p>Extract the tarball: <code>sudo tar zxvf jre-8u*version*-linux-x64.tar.gz</code></p></li><li><p>Install: <code>sudo update-alternatives --install /usr/bin/java java /usr/local/java/jre-8u*version*/bin/java 1</code></p></li><li><p>Check that the installation was successful: <code>java -version</code></p></li><li><p>Clean up files: <code>sudo rm jre-8u*version*-linux-x64.tar.gz</code></p></li></ul></li></ul></li><li><p>Install <a class="external-link" href="https://nodejs.org/en/download/" rel="nofollow">Node.js/npm</a>.</p></li><li><p>Use Node.js to version 16.17.0.</p></li></ol><ul><li><p><code>sudo npm install -g n</code>.</p></li><li><p><code>sudo n 16.17.0</code>.</p></li><li><p>Check via. <code>node --version</code>.</p></li></ul><ol start="1"><li><p>Install <a class="external-link" href="https://yarnpkg.com/" rel="nofollow">Yarn</a> version 1.22.10.</p></li></ol><ul><li><p><code>sudo npm install --global yarn@1.22.10</code>.</p></li><li><p>Check via. <code>yarn --version</code>.</p></li></ul><ol start="1"><li><p>Install <a class="external-link" href="https://aws.amazon.com/cli/" rel="nofollow">AWS-CLI</a> version 2.4.3.</p></li></ol><ul><li><p>Download from the link above.</p></li><li><p>Check via. <code>aws --version</code>.</p></li></ul><ol start="1"><li><p>Install <a class="external-link" href="https://www.serverless.com/" rel="nofollow">Serverless</a> version 2.6.0.</p></li></ol><ul><li><p><code>sudo npm install -g serverless@2.6.0</code>.</p></li><li><p>Check version via. <code>serverless --version</code>.</p></li><li><p>Check execution via. <code>serverless</code>.</p></li></ul><ol start="1"><li><p>Install dependencies + ServiceRocket npmJS. (@servicerocket/conf-cloud-utils)</p></li></ol><ul><li><p>Get the ServiceRocket NPM Access Token in <a class="external-link" href="https://rocketeers.atlassian.net/wiki/spaces/GREENENG/pages/2165474283/Shared+Services" rel="nofollow">Secrets</a>.</p></li><li><p>Scroll down to the <strong>ServiceRocket NPM Access Tokens</strong> section and click <strong>Decrypt</strong>.</p></li><li><p>Create a <code>.npmrc</code> file in the root directory and add the following line:</p><p>\]\]&gt;</p></li><li><p>Restart your terminal, and run <code>yarn install</code> or <code>yarn</code> from this repo's root directory to connect to ServiceRocket's registry to successfully install @servicerocket/conf-cloud-utils!</p></li></ul><ol start="1"><li><p>Create and setup a new instance of an Atlassian cloud development site <a class="external-link" href="https://go.atlassian.com/cloud-dev" rel="nofollow">here</a>.</p></li><li><p>Enable development mode and private listings in your Atlassian cloud development site.</p></li></ol><ul><li><p>Go to your instance's manage apps page (<code>&lt;&lt;https://&lt;instance&gt;&gt; name&gt;.atlassian.net/wiki/plugins/servlet/upm</code>), then click Settings.</p></li><li><p>Click on the 'Enable private listings' and 'Enable development mode' checkboxes to allow the installation of staging and local instances.</p></li></ul><ol start="1"><li><p>Run <code>cp backend/credentials.json.template backend/credentials.json</code>.</p></li><li><p>Generate an Atlassian API <a class="external-link" href="https://id.atlassian.com/manage-profile/security/api-tokens" rel="nofollow">token</a>.</p></li><li><p>Add this token along with your Confluence site URL and ServiceRocket email address to backend/credentials.json.</p></li><li><p>Setup your AWS Credentials by grabbing the API Environment Variables from <a class="external-link" href="https://servicerocket.awsapps.com/start#/" rel="nofollow">https://servicerocket.awsapps.com/start#/</a> (ServiceRocket Apps Lab-&gt;Researcher-&gt;Programmatic Access). Add the three lines below to your ~/.bash\_profile file and run the same above three lines in your terminal.</p></li></ol><p>sh export AWS\_SECRET\_ACCESS\_KEY= export AWS\_SESSION\_TOKEN=\]\]&gt;</p><p>Note:</p><ul><li><p>The team runs the project locally with its <a class="external-link" href="https://ngrok.com/" rel="nofollow">ngrok</a> url exposed automatically to the Internet for installation. In order to start an ngrok instance, you must first <a class="external-link" href="https://ngrok.com/" rel="nofollow">sign up</a> for a free ngrok account.</p><p>Next, install ngrok by running the following command in your terminal:</p><p>Authenticate by registering your <a class="external-link" href="https://dashboard.ngrok.com/get-started/your-authtoken" rel="nofollow">authtoken</a>.</p><p>\]\]&gt;</p><p>When accessing your Atlassian cloud development site after successfully installing the add-on, you may be prompted by ngrok to click on the &quot;Visit Site&quot; button before it is able to display the content.</p></li><li><p>Alternatively, you can use <a class="external-link" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html" rel="nofollow">AWS CLI</a>  <br/><em>(check your</em> <a class="external-link" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-config-files.html" rel="nofollow"><em>configuration and credential</em></a><em>)</em>  <br/>is required for deployment to AWS.  <br/>Use AWS credentials retrieved from <a class="external-link" href="https://servicerocket.awsapps.com/start#/" rel="nofollow">AWS SSO</a>.  <br/>If you do not have access to AWS SSO, please refer to this <a class="external-link" href="https://rocketeers.atlassian.net/l/c/h5mCpj1A" rel="nofollow">guide</a>.</p></li></ul><h1 id="Docsconverted-InstallandRunLocally(recommended)">Install and Run Locally (recommended)</h1><ol start="1"><li><p>Install dependencies by running this command in the <code>root</code> directory.</p><ul><li><p><code>yarn</code></p></li></ul></li><li><p>Run this command in a separate terminal to run the frontend.</p><ul><li><p><code>./startup-front-linux.sh</code> (for Linux)</p></li></ul><p>This will have:</p><ul><li><p><code>frontend/</code> running locally at <code>&lt;&lt;https://localhost:3001</code>.&gt;&gt;</p></li></ul><p>The local frontend has 3 main components:</p><ul><li><p>Dashboard View (<a class="external-link" href="https://localhost:3001/etc/dashboard.html" rel="nofollow">https://localhost:3001/etc/dashboard.html):</a>:) defined in <code>/frontend/etc/dashboard.html</code>.</p></li><li><p>Space Settings View (<a class="external-link" href="https://localhost:3001/etc/space-settings.html" rel="nofollow">https://localhost:3001/etc/space-settings.html):</a>:) defined in <code>/frontend/etc/space-settings.html</code>.</p></li><li><p>Dialog View (<a class="external-link" href="https://localhost:3001/etc/update-approver.html" rel="nofollow">https://localhost:3001/etc/update-approver.html):</a>:) defined in <code>/frontend/etc/update-approver.html</code>.</p></li></ul></li><li><p>Run <code>yarn dev</code>, this will have:</p><ul><li><p><code>backend/</code> running locally at <code>&lt;&lt;http://localhost:3000</code>\&gt;&gt; and exposed via ngrok automatically.</p></li><li><p>A local DynamoDB running locally at <code>&lt;&lt;http://localhost:8000/shell</code>.&gt;&gt;</p></li><li><p>A local ElasticMQ running locally at <code>&lt;&lt;http://localhost:9324/</code>\&gt;&gt;</p></li><li><p>Ngrok URL in the output is how your add-on is served.</p></li></ul></li><li><p>Run the 'i' command from the terminal running the <code>yarn dev</code> command. (after &quot;Enter &quot;rp&quot; to replay the last request&quot;)</p></li><li><p>Run <code>aws dynamodb list-tables --endpoint-url &lt;&lt;http://localhost:8000</code>\&gt;&gt; in another terminal to check if you can connect to the add-on's AWS server.</p></li><li><p>Create a page Confluence site and click the <code>Request approval</code> button on the top-right corner to open the approval dialog.</p></li></ol><h1 id="Docsconverted-MarketplaceinstallationtotestStaging/ProductionPageApproval">Marketplace installation to test Staging/Production Page Approval</h1><ol start="1"><li><p>Go to the marketplace vendor account <a class="external-link" href="https://marketplace.atlassian.com/manage/vendors/1212722/addons" rel="nofollow">here</a>. Change the vendor into <strong>ServiceRocket Labs</strong> for Staging and <strong>ServiceRocket</strong> for Production.</p></li><li><p>Search the <strong>Page Approval for Confluence</strong> app, go to <strong>Private listings</strong> and create a token.</p></li><li><p>Install the add-on use the provided url to register your cloud instance to the token.</p></li><li><p>You can now use the token for local or staging development by pasting it to the text box on <code>Manage apps</code> page.</p></li></ol>